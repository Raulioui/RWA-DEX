# Aderyn Analysis Report

This report was generated by [Aderyn](https://github.com/Cyfrin/aderyn), a static analysis tool built by [Cyfrin](https://cyfrin.io), a blockchain security company. This report is not a substitute for manual audit or security review. It should not be relied upon for any purpose other than to assist in the identification of potential security vulnerabilities.
# Table of Contents

- [Summary](#summary)
  - [Files Summary](#files-summary)
  - [Files Details](#files-details)
  - [Issue Summary](#issue-summary)
- [High Issues](#high-issues)
  - [H-1: Reentrancy: State change after external call](#h-1-reentrancy-state-change-after-external-call)
- [Low Issues](#low-issues)
  - [L-1: Centralization Risk](#l-1-centralization-risk)
  - [L-2: Unsafe ERC20 Operation](#l-2-unsafe-erc20-operation)
  - [L-3: Address State Variable Set Without Checks](#l-3-address-state-variable-set-without-checks)
  - [L-4: Public Function Not Used Internally](#l-4-public-function-not-used-internally)
  - [L-5: Literal Instead of Constant](#l-5-literal-instead-of-constant)
  - [L-6: Modifier Invoked Only Once](#l-6-modifier-invoked-only-once)
  - [L-7: Large Numeric Literal](#l-7-large-numeric-literal)
  - [L-8: Unused Error](#l-8-unused-error)
  - [L-9: Loop Contains `require`/`revert`](#l-9-loop-contains-requirerevert)
  - [L-10: Costly operations inside loop](#l-10-costly-operations-inside-loop)
  - [L-11: Unused Import](#l-11-unused-import)
  - [L-12: State Change Without Event](#l-12-state-change-without-event)
  - [L-13: State Variable Could Be Immutable](#l-13-state-variable-could-be-immutable)
  - [L-14: Unchecked Return](#l-14-unchecked-return)


# Summary

## Files Summary

| Key | Value |
| --- | --- |
| .sol Files | 7 |
| Total nSLOC | 871 |


## Files Details

| Filepath | nSLOC |
| --- | --- |
| src/AssetPool.sol | 341 |
| src/AssetToken.sol | 336 |
| src/ChainlinkCaller.sol | 90 |
| src/interfaces/IAssetToken.sol | 66 |
| src/interfaces/IChainlinkCaller.sol | 6 |
| src/interfaces/IGetChainlinkConfig.sol | 9 |
| src/libraries/OracleLib.sol | 23 |
| **Total** | **871** |


## Issue Summary

| Category | No. of Issues |
| --- | --- |
| High | 1 |
| Low | 14 |


# High Issues

## H-1: Reentrancy: State change after external call

Changing state after an external call can lead to re-entrancy attacks.Use the checks-effects-interactions pattern to avoid this issue.

<details><summary>6 Found Instances</summary>


- Found in src/AssetPool.sol [Line: 208](src/AssetPool.sol#L208)

	State is changed at: `userRequests[msg.sender].push(requestId)`
	```solidity
	        requestId = IAssetToken(asset.assetAddress)._mintAsset(
	```

- Found in src/AssetPool.sol [Line: 240](src/AssetPool.sol#L240)

	State is changed at: `userRequests[msg.sender].push(requestId)`
	```solidity
	        requestId = IAssetToken(asset.assetAddress)._redeemAsset(
	```

- Found in src/AssetPool.sol [Line: 325](src/AssetPool.sol#L325)

	State is changed at: `assetInfo[ticket] = Asset({
            id: assetCounter,
            assetAddress: tokenAddress,
            uri: imageCid,
            name: name
        })`, `assetTickets.push(ticket)`, `assetCounter++`
	```solidity
	        usdt.approve(tokenAddress, type(uint256).max);
	```

- Found in src/AssetPool.sol [Line: 326](src/AssetPool.sol#L326)

	State is changed at: `assetInfo[ticket] = Asset({
            id: assetCounter,
            assetAddress: tokenAddress,
            uri: imageCid,
            name: name
        })`, `assetTickets.push(ticket)`, `assetCounter++`
	```solidity
	        IChainlinkCaller(chainlinkCaller).authorizeToken(ticket, tokenAddress);
	```

- Found in src/AssetToken.sol [Line: 175](src/AssetToken.sol#L175)

	State is changed at: `requestIdToRequest[requestId] = AssetRequest({
            amount: usdAmount,
            requester: requester,
            mintOrRedeem: MintOrRedeem.mint,
            status: RequestStatus.pending,
            deadline: deadline,
            createdAt: block.timestamp,
            amountExpected: assetAmountExpected
        })`, `userToRequests[requester].push(requestIdToRequest[requestId])`
	```solidity
	        requestId = IChainlinkCaller(chainlinkCaller).requestMint(
	```

- Found in src/AssetToken.sol [Line: 204](src/AssetToken.sol#L204)

	State is changed at: `requestIdToRequest[requestId] = AssetRequest({
            amount: assetAmount,
            requester: requester,
            mintOrRedeem: MintOrRedeem.redeem,
            status: RequestStatus.pending,
            deadline: deadline,
            createdAt: block.timestamp,
            amountExpected: usdAmountExpected
        })`, `userToRequests[requester].push(requestIdToRequest[requestId])`
	```solidity
	        requestId = IChainlinkCaller(chainlinkCaller).requestRedeem(
	```

</details>



# Low Issues

## L-1: Centralization Risk

Contracts have owners with privileged rights to perform admin tasks and need to be trusted to not perform malicious updates or drain funds.

<details><summary>13 Found Instances</summary>


- Found in src/AssetPool.sol [Line: 176](src/AssetPool.sol#L176)

	```solidity
	    function initializeBeacon(address implementation) external onlyOwner {
	```

- Found in src/AssetPool.sol [Line: 306](src/AssetPool.sol#L306)

	```solidity
	    ) external onlyOwner beaconInitialized returns(address) {
	```

- Found in src/AssetPool.sol [Line: 347](src/AssetPool.sol#L347)

	```solidity
	    function upgradeAllAssetTokens(address newImplementation) external onlyOwner beaconInitialized {
	```

- Found in src/AssetPool.sol [Line: 360](src/AssetPool.sol#L360)

	```solidity
	    function removeTokenRegistry(string calldata ticket) external onlyOwner {
	```

- Found in src/AssetPool.sol [Line: 382](src/AssetPool.sol#L382)

	```solidity
	    function setRequestTimeout(uint256 newTimeout, address asset) external onlyOwner {
	```

- Found in src/AssetPool.sol [Line: 389](src/AssetPool.sol#L389)

	```solidity
	    function expireRequests(bytes32[] calldata requestIds, address asset) external onlyOwner {
	```

- Found in src/AssetPool.sol [Line: 396](src/AssetPool.sol#L396)

	```solidity
	    function emergencyPause() external onlyOwner {
	```

- Found in src/AssetPool.sol [Line: 403](src/AssetPool.sol#L403)

	```solidity
	    function unpause() external onlyOwner {
	```

- Found in src/AssetToken.sol [Line: 338](src/AssetToken.sol#L338)

	```solidity
	    ) external onlyOwner validTimeout(newTimeout) {
	```

- Found in src/AssetToken.sol [Line: 344](src/AssetToken.sol#L344)

	```solidity
	    function _expireRequests(bytes32[] calldata requestIds) external onlyOwner {
	```

- Found in src/ChainlinkCaller.sol [Line: 137](src/ChainlinkCaller.sol#L137)

	```solidity
	    function setJsSources(string memory _mintSource, string memory _sellSource) external onlyOwner {
	```

- Found in src/ChainlinkCaller.sol [Line: 146](src/ChainlinkCaller.sol#L146)

	```solidity
	    function setAssetPool(address _assetPool) external onlyOwner {
	```

- Found in src/ChainlinkCaller.sol [Line: 151](src/ChainlinkCaller.sol#L151)

	```solidity
	    function setSecretVersion(uint64 _secretVersion) external onlyOwner {
	```

</details>



## L-2: Unsafe ERC20 Operation

ERC20 functions may not behave as expected. For example: return values are not always meaningful. It is recommended to use OpenZeppelin's SafeERC20 library.

<details><summary>1 Found Instances</summary>


- Found in src/AssetPool.sol [Line: 325](src/AssetPool.sol#L325)

	```solidity
	        usdt.approve(tokenAddress, type(uint256).max);
	```

</details>



## L-3: Address State Variable Set Without Checks

Check for `address(0)` when assigning values to address state variables.

<details><summary>4 Found Instances</summary>


- Found in src/AssetToken.sol [Line: 159](src/AssetToken.sol#L159)

	```solidity
	        assetPool = _assetPool;
	```

- Found in src/AssetToken.sol [Line: 160](src/AssetToken.sol#L160)

	```solidity
	        usdt = IERC20(_usdt);
	```

- Found in src/AssetToken.sol [Line: 161](src/AssetToken.sol#L161)

	```solidity
	        chainlinkCaller = _chainlinkCaller;
	```

- Found in src/ChainlinkCaller.sol [Line: 148](src/ChainlinkCaller.sol#L148)

	```solidity
	        assetPool = _assetPool;
	```

</details>



## L-4: Public Function Not Used Internally

If a function is marked public but is not used internally, consider marking it as `external`.

<details><summary>2 Found Instances</summary>


- Found in src/libraries/OracleLib.sol [Line: 23](src/libraries/OracleLib.sol#L23)

	```solidity
	    function staleCheckLatestRoundData(AggregatorV3Interface chainlinkFeed)
	```

- Found in src/libraries/OracleLib.sol [Line: 40](src/libraries/OracleLib.sol#L40)

	```solidity
	    function getTimeout(AggregatorV3Interface /* chainlinkFeed */ ) public pure returns (uint256) {
	```

</details>



## L-5: Literal Instead of Constant

Define and use `constant` variables instead of using literals. If the same constant literal value is used multiple times, create a constant state variable and reference it throughout the contract.

<details><summary>6 Found Instances</summary>


- Found in src/AssetToken.sol [Line: 244](src/AssetToken.sol#L244)

	```solidity
	                    MAX_SLIPPAGE_BASIS_POINTS) / 100;
	```

- Found in src/AssetToken.sol [Line: 246](src/AssetToken.sol#L246)

	```solidity
	                    MIN_SLIPPAGE_BASIS_POINTS) / 100;
	```

- Found in src/AssetToken.sol [Line: 258](src/AssetToken.sol#L258)

	```solidity
	                    MAX_SLIPPAGE_BASIS_POINTS) / 100;
	```

- Found in src/AssetToken.sol [Line: 260](src/AssetToken.sol#L260)

	```solidity
	                    MIN_SLIPPAGE_BASIS_POINTS) / 100;
	```

- Found in src/ChainlinkCaller.sol [Line: 68](src/ChainlinkCaller.sol#L68)

	```solidity
	        string[] memory args = new string[](3);
	```

- Found in src/ChainlinkCaller.sol [Line: 86](src/ChainlinkCaller.sol#L86)

	```solidity
	        string[] memory args = new string[](3);
	```

</details>



## L-6: Modifier Invoked Only Once

Consider removing the modifier or inlining the logic into the calling function.

<details><summary>3 Found Instances</summary>


- Found in src/AssetPool.sol [Line: 141](src/AssetPool.sol#L141)

	```solidity
	    modifier validAmount(uint256 amount) {
	```

- Found in src/AssetToken.sol [Line: 112](src/AssetToken.sol#L112)

	```solidity
	    modifier validTimeout(uint256 timeout) {
	```

- Found in src/AssetToken.sol [Line: 123](src/AssetToken.sol#L123)

	```solidity
	    modifier onlyChainlinkCaller() {
	```

</details>



## L-7: Large Numeric Literal

Large literal values multiples of 10000 can be replaced with scientific notation.Use `e` notation, for example: `1e18`, instead of its full numeric value.

<details><summary>3 Found Instances</summary>


- Found in src/AssetPool.sol [Line: 92](src/AssetPool.sol#L92)

	```solidity
	    uint256 public constant MAX_USD_AMOUNT = 10_000 * 1e6;
	```

- Found in src/AssetPool.sol [Line: 94](src/AssetPool.sol#L94)

	```solidity
	    uint256 public constant BASIS_POINTS = 10000;
	```

- Found in src/ChainlinkCaller.sol [Line: 38](src/ChainlinkCaller.sol#L38)

	```solidity
	    uint32 private constant GAS_LIMIT = 300_000;
	```

</details>



## L-8: Unused Error

Consider using or removing the unused error.

<details><summary>3 Found Instances</summary>


- Found in src/AssetPool.sol [Line: 36](src/AssetPool.sol#L36)

	```solidity
	    error ArrayLengthMismatch();
	```

- Found in src/AssetToken.sol [Line: 30](src/AssetToken.sol#L30)

	```solidity
	    error NotAllowedToRedeem();
	```

- Found in src/AssetToken.sol [Line: 32](src/AssetToken.sol#L32)

	```solidity
	    error RequestNotPending();
	```

</details>



## L-9: Loop Contains `require`/`revert`

Avoid `require` / `revert` statements in a loop because a single bad item can cause the whole transaction to fail. It's better to forgive on fail and return failed elements post processing of the loop

<details><summary>2 Found Instances</summary>


- Found in src/AssetToken.sol [Line: 287](src/AssetToken.sol#L287)

	```solidity
	        for (uint256 i = 0; i < requestIds.length; i++) {
	```

- Found in src/AssetToken.sol [Line: 345](src/AssetToken.sol#L345)

	```solidity
	        for (uint256 i = 0; i < requestIds.length; i++) {
	```

</details>



## L-10: Costly operations inside loop

Invoking `SSTORE` operations in loops may waste gas. Use a local variable to hold the loop computation result.

<details><summary>3 Found Instances</summary>


- Found in src/AssetPool.sol [Line: 366](src/AssetPool.sol#L366)

	```solidity
	        for (uint256 i = 0; i < assetTickets.length; i++) {
	```

- Found in src/AssetToken.sol [Line: 287](src/AssetToken.sol#L287)

	```solidity
	        for (uint256 i = 0; i < requestIds.length; i++) {
	```

- Found in src/AssetToken.sol [Line: 345](src/AssetToken.sol#L345)

	```solidity
	        for (uint256 i = 0; i < requestIds.length; i++) {
	```

</details>



## L-11: Unused Import

Redundant import statement. Consider removing it.

<details><summary>1 Found Instances</summary>


- Found in src/AssetPool.sol [Line: 5](src/AssetPool.sol#L5)

	```solidity
	import { AssetToken } from "../src/AssetToken.sol";
	```

</details>



## L-12: State Change Without Event

There are state variable changes in this function but no event is emitted. Consider emitting an event to enable offchain indexers to track the changes.

<details><summary>7 Found Instances</summary>


- Found in src/AssetToken.sol [Line: 169](src/AssetToken.sol#L169)

	```solidity
	    function _mintAsset(
	```

- Found in src/AssetToken.sol [Line: 198](src/AssetToken.sol#L198)

	```solidity
	    function _redeemAsset(
	```

- Found in src/ChainlinkCaller.sol [Line: 123](src/ChainlinkCaller.sol#L123)

	```solidity
	    function authorizeToken(string memory ticket, address token) external {
	```

- Found in src/ChainlinkCaller.sol [Line: 129](src/ChainlinkCaller.sol#L129)

	```solidity
	    function deAuthorizeToken(string memory ticket, address token) external {
	```

- Found in src/ChainlinkCaller.sol [Line: 137](src/ChainlinkCaller.sol#L137)

	```solidity
	    function setJsSources(string memory _mintSource, string memory _sellSource) external onlyOwner {
	```

- Found in src/ChainlinkCaller.sol [Line: 146](src/ChainlinkCaller.sol#L146)

	```solidity
	    function setAssetPool(address _assetPool) external onlyOwner {
	```

- Found in src/ChainlinkCaller.sol [Line: 151](src/ChainlinkCaller.sol#L151)

	```solidity
	    function setSecretVersion(uint64 _secretVersion) external onlyOwner {
	```

</details>



## L-13: State Variable Could Be Immutable

State variables that are only changed in the constructor should be declared immutable to save gas. Add the `immutable` attribute to state variables that are only changed in the constructor

<details><summary>2 Found Instances</summary>


- Found in src/ChainlinkCaller.sol [Line: 34](src/ChainlinkCaller.sol#L34)

	```solidity
	    uint64 public subId;
	```

- Found in src/ChainlinkCaller.sol [Line: 35](src/ChainlinkCaller.sol#L35)

	```solidity
	    bytes32 public donID;
	```

</details>



## L-14: Unchecked Return

Function returns a value but it is ignored. Consider checking the return value.

<details><summary>1 Found Instances</summary>


- Found in src/AssetPool.sol [Line: 325](src/AssetPool.sol#L325)

	```solidity
	        usdt.approve(tokenAddress, type(uint256).max);
	```

</details>



